function stopApp(name)
  app = hs.application.get(name)
  if app and app:isRunning() then
    app:kill()
  end
end

function forceKillProcess(name)
  hs.execute("pkill " .. name)
end

function startApp(name)
  hs.application.open(name)
end

--[[
	hs.loadSpoon("WiFiTransitions")
	Install:andUse("WiFiTransitions",
               {
                 config = {
                   actions = {
                     -- { -- Test action just to see the SSID transitions
                     --    fn = function(_, _, prev_ssid, new_ssid)
                     --       hs.notify.show("SSID change",
                     --          string.format("From '%s' to '%s'",
                     --          prev_ssid, new_ssid), "")
                     --    end
                     -- },
                     { -- Enable proxy config when joining corp network
                       to = "corpnet01",
                       fn = {hs.fnutils.partial(reconfigSpotifyProxy, true),
                             hs.fnutils.partial(reconfigAdiumProxy, true),
                             hs.fnutils.partial(forceKillProcess, "Dropbox"),
                             hs.fnutils.partial(stopApp, "Evernote"),
                       }
                     },
                     { -- Disable proxy config when leaving corp network
                       from = "corpnet01",
                       fn = {hs.fnutils.partial(reconfigSpotifyProxy, false),
                             hs.fnutils.partial(reconfigAdiumProxy, false),
                             hs.fnutils.partial(startApp, "Dropbox"),
                       }
                     },
                   }
                 },
                 start = true,
               }
)
]]


--[[	URL dispatching
	
	function appID(app)
  		if hs.application.infoForBundlePath(app) then
    		return hs.application.infoForBundlePath(app)['CFBundleIdentifier']
  		end
	end
	

	-- Returns a function that takes a URL and opens it in the given Chrome profile
	-- Note: the value of `profile` must be the name of the profile directory under
	-- ~/Library/Application Support/Google/Chrome/
	function chromeProfile(profile)
  		return function(url)
    		hs.task.new("/usr/bin/open", nil, { "-n",
                                        "-a", "Google Chrome",
                                        "--args",
                                        "--profile-directory="..profile,
                                        url }):start()
  		end
	
	end

	-- Define the IDs of the various applications used to open URLs
	chromeBrowser  = appID('/Applications/Google Chrome.app')
	braveBrowser   = appID('/Applications/Brave Browser.app')
	safariBrowser  = appID('/Applications/Safari.app')
	firefoxBrowser = appID('/Applications/Firefox.app')
	arcBrowser     = appID('/Applications/Arc.app')
	teamsApp       = appID('/Applications/Microsoft Teams.app')
	quipApp        = appID('/Applications/Quip.app')
	chimeApp       = appID('/Applications/Amazon Chime.app')

	-- Define my default browsers for various purposes
	browsers = {
  		default    = arcBrowser,
  		awsConsole = firefoxBrowser,
  		work       = chromeProfile("Default"),
  		customer1  = chromeProfile("Profile 1")
	}

	-- Read URL patterns from text files
	URLfiles = {
  		work      = "local/work_urls.txt",
  		customer1 = "local/customer1_urls.txt"
	}

	Install:andUse("URLDispatcher",
               {
                 config = {
                   default_handler = browsers.default,
                   url_patterns = {
                     -- URLs that get redirected to applications
                     { "https://quip%-amazon%.com/"      , quipApp },
                     { "https://teams%.microsoft%.com/"  , teamsApp },
                     { "chime://"                        , chimeApp },
                     -- Customer-specific URLs open in their own Chrome profile
                     { URLfiles.customer1                , browsers.customer1 },
                     -- AWS console URLs open by default in Firefox because it
                     -- has better plugins to improve the experience. This comes
                     -- after customer1 URLs because I have patterns for that
                     -- customer's accounts to open in its corresponding
                     -- profile.
                     { ".*%.console%.aws%.amazon%.com/.*", browsers.awsConsole },
                     -- Work-related URLs open in the default Chrome profile
                     { URLfiles.work                     , browsers.work },
                   },
                   url_redir_decoders = {
                     -- URLs opened from within MS Teams are normally sent
                     -- through a redirect which messes the matching, so we
                     -- extract the final URL before dispatching it. The final
                     -- URL is passed as parameter "url" to the redirect URL,
                     -- which makes it easy to extract it using a function-based
                     -- decoder.
                     { "MS Teams links", function(_, _, params) return params.url end, nil, true, "Microsoft Teams" },
                     -- URLs within a tracking link
                     { "awstrack.me links", "https://.*%.awstrack%.me/.-/(.*)", "%1" },
                     -- Chime meeting URLs get rewritten to open in the Chime app
                     { "Chime meeting links", "https://chime%.aws/(%d+)", "chime://meeting?pin=%1" }
                   }
                 },
                 start = true,
                 loglevel = 'debug'
               }
)
]]
